* Introduction

The Danish National Prescription Registry (NCBI) provides
individual-level data on all prescription drugs sold in Danish
community pharmacies since 1994 citep:kildemoes2011danish. Effects and
side effects of drugs can be assessed in a Danish nation wide registry
studies. For this the prescription data are linked to the cause of
death register and other Danish registries
citep:thygesen2011introduction.

This document describes a complex algorithm for the computation of
drug exposure strength and length relative to a prespecified study
period \period. Note that the start of the study period has to be
after the start of the registry.

* Drug prescription data

We describe the data of a single person who has purchased the drug of
interest at ${K}$ different dates in the study period \period. The
setup can easily be generalized to multiple individuals. The set of
ordered drug purchase dates for one individual is denoted as
\begin{equation*}
{T}_1< \cdots< {T}_{K}.
\end{equation*}
One package of each drug product is defined by the drug strength
\(\str\) of the smallest unit (e.g., one pill or half a pill) and the
amount of such units that it contains. For each drug we distinguish
\(J\ge 1\) different package types according to the different
strengths: \(\str_1,\dots,\str_J\). For each drug strength \(\str_j\) the values \(\smin_j\), \(\smax_j\), \(\styp_j\)
 define the minimal, maximal and typical dose per day, respectively. Note that
the original SAS macro allowed at most 4 different package types. We
combine all packages purchased on the same date that have the same
strength. The number of smallest units, \(\smin_j\), of type
\(j\) purchased on date \(T_k\) is denoted by \(\tilde{n}_{jk}\). Thus, the
total amount \(D_k\) of the drug purchased on date \(T_k\) is given by
the formula
\begin{align*}
D_k=\frac{1}{\# J_k} \sum_{j=1}^J\tilde{n}_{jk}\smin_{j} = \sum_{j=1}^J n_{jk} \smin_j,
\end{align*}
where \(\# J_k = \sum_{j=1} ^J \one \lbrace n_{jk}>0\rbrace\) is the number of different drugs purchased on date \(T_k\). Note that \(n_{jk} = \tilde{n}_{jk} \mathbin{/} (\# J_k)\). \\
FIXME: does it actually  make sense to divide with number of different drugs (as done in macro)?\\
FIXME: this way of defining the dosis does not fit with the calculation of dosis sequences... 
Figure ref:fig:1 illustrates the data

#+BEGIN_SRC R :results output raw drawer  :exports none :session *R* :cache yes 
if (system("echo $USER",intern=TRUE)=="tag")
    setwd("~/research/SoftWare/heaven/worg/")
else
    setwd("p:/HELY/medicin-macro/heaven/worg/")
#+END_SRC

#+RESULTS[<2016-10-17 16:50:14> 0862612a285251181b55a1c4c66caec26359f50d]:
:RESULTS:
 Error in system("echo $USER", intern = TRUE) : 'echo' not found
Error: unexpected 'else' in "else"
:END:

#+BEGIN_SRC R :results graphics :file "./drug-data.png" :exports none :session *R* :cache yes 
plot(0,0,type="n",xlim=c(0,100),ylim=c(0,100),xlab="Calendar time",ylab="")
segments(x0=30,x1=50,y0=10,y1=10,lwd=3)
#+END_SRC

#+RESULTS[<2016-10-17 16:47:59> 48854c356af0ca07dbf4d5ef0fd83efe8cba1a44]:
[[file:./drug-data.png]]


#+LABEL: fig:1
#+ATTR_LATEX: :width 0.7\textwidth
#+CAPTION: label til figure
[[file:./drug-data.png]]

* Hospital admission data

Hospitals usually deliver drugs for their patients. It is therefore
hensigtsmaessig to take into account periods of hospitalization in the
calculation of exposure lengths. For a single individual we define up
to \(Q\) periods of hospitalization by the admission dates
${L}_1,\ldots, {L}_{{Q}}$ and the corresponding discharge dates
${R}_1,\ldots, {R}_{{Q}}$. 

We compute the number of days hospitalized in the period \(\periodK\)
as:
\begin{align*} 
{A}_{k} &= \sum_{q=1}^{{Q}} \max \big( 0,\,\min \left({T}_{k+1},{R}_{q}\right) - \max\left({T}_{k}, {L}_{q}\right)
\big).
\intertext{Accordingly the number of non-hospitalized days in \(\periodK\) is:}
C_k &= \left({T}_{k+1} - {T}_{k}\right) - {A}_{k}.
\end{align*}

FIXME: 
- need to limit to the study period \period?
- is the day \(T_{k+1}\) included in \periodK or not?}[3cm]

* Exposure strength and exposure lengths

The aim is to calculate the ends of the exposure periods \(E_k\) and
for each exposure period the exposure strength per day \(X_k\). The
calculations of exposure are based on the drug prescription data and
the hospitalization dates and depend further on the following
parameters. An integer \(\lag\) defines the number of
prescription dates back in time to use in the calculations of exposure
in a given period \periodK.

To express the exposure in period \(\periodK\) we first note that
based on the total drug purchase on date \(T_k\) the individual can be
exposed at most \(n_k=\sum_{j=1}^J n_{jk}\) days. 

FIXME: would it not be more logical to use \(\tilde n_k = n_{jk}
\frac{S_j}{\smin_j}\) instead of \(n_k\)? Helene: Not relevant any longer.


We use the following notation to indicate if the maximal number of
exposure days exceeds the non-hospitalized days in period \periodK:
\begin{align*} 
u_{k} = \begin{cases}
0, & n_{k} \le C_k\\
1, & n_{k} > C_k
\end{cases}.
\end{align*}
We use $\bar{Y}_{k}$ to denote the history of a variable $Y$ up to
period $k$. For example,
\begin{align*}
\bar{D}_{k} = \left( D_{k} ,D_{k-1}, \ldots, D_1\right)
\end{align*}
is the history of total drug purchase until and including date \(T_k\).

*** Calculating the doses, ${X}_1, \ldots, {X}_{{K}}$

HELENE: we need to adapt the following formula to the new notations.

#+BEGIN_SRC latex :export results :eval t
\begin{align*} 
&{X}_{k} = (1-u_k)\, (1-u_{k-1}) \, d_{k}^*
\\ & \qquad + \, u_{k-1}\, \Big(1\{D_{k-1}=D_{k}\} \, {z}(
\bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} ) + 1\{D_{k-1}\ne D_{k}\}\,
{w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} ) \Big) \\ & \qquad +
\,u_{k} \,(1-u_{k-1})\, {w}( \bar{S}_{k}, \bar{D}_{k},
\bar{{C}}_{k} ).
\end{align*}

Here, ${z}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )$ and
${w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )$ are
calculated from the mean dose 
\begin{align*}
M^{{z}, {w}}_{jk} = \frac{\sum_{i \in {I}^{z, w}_{k}}n_{ij}\smin_j}{\sum_{i \in {I}^{{z}, {w}}_{k}} {C}_i},
\end{align*}
where

\begin{align*}
{I}^{{w}}_{k} = \big\lbrace \min \lbrace i : u_i = \cdots = u_{k-1} =1 \rbrace, \ldots, k-1\big\rbrace,
\end{align*}
and, 
\begin{align*}
{I}^{{z}}_{k} = \big\lbrace \max \big( &\min \lbrace i : u_i = \cdots = u_{k-1} =1 \rbrace, \\
&  \min \lbrace i :  s_i = \cdots = s_{k}  \rbrace \big), \ldots, k-1 \big\rbrace,
\end{align*}
where 
\begin{align*}
s_i = 
\end{align*}
according to
 \begin{align*}
{z}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )& = \sum_{j=1}^J \text{round}\,\Big ( M_{jk}^{{z}} \mathbin{/} \smin_{j}\Big) \cdot \smin_{j}, \\
{w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )& = \frac{1}{\#J_k}\sum_{j=1}^J\max \Big(\one \lbrace n_{jk} >0\rbrace \, \smin_j, \, \one \lbrace M_{jk}^{{w}} > \smax_{j} \rbrace\, \smax_{j} + \one\lbrace M_{jk}^{{w}} < \smin_{j} \rbrace\, 
 \smin_{j}\\
& + \one \lbrace \smin_{j} \le M_{jk}^{{w}} \le \smax_{j} \rbrace \,\styp_{j}\Big),
\end{align*}
#+END_SRC

where, again, \(\#J_k= \sum_{j= 1}^J \one\lbrace n_{jk} > 0\rbrace\) is the number of different drugs purchased on date \(T_k\).\\ 


*** Calculating the end dates, ${E}_1,\ldots, {E}_{k}$

\begin{align*}
{E}_{k}= \min \bigg[ {T}_{k+1}-1, \, (1-u_{k})\, (1-u_{k-1})  \, \bigg( {T}_{k} - 1+ \text{round} \left( \tfrac{D_{k} + {R}_{k}}{d_{k}^*} \right)\bigg) + \\
 \left(1-(1-u_{k})\, (1-u_{k-1}) \right)  \, \bigg( {T}_{k} - 1+ \text{round} \left( \tfrac{D_{k} + {R}_{k}}{{X}_{k}} \right)\bigg)\bigg]
\end{align*}

*** Calculating the leftover dose, ${R}_1,\ldots, {R}_{k}$

\begin{align*}
{R}_{k} = \Big( D_{k-1} + {R}_{k-1} - {X}_{k-1} \left( {E}_{k-1} - {T}_{k-1} \right) \Big) \, u_{k}.\end{align*}



* User interface

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes 
obj <- dpp()
period(obj) <- as.Date("1995-01-01","2011-01-01")
drugdb(obj,pnr~eksd) <- recipe.db
admdb(obj,pnr~inddato+uddato) <- lpr.db
drug(obj,~painkiller) <- atc("B097BN3V")
dosis(obj,~painkiller) <- package(value,default=75,min=75,max=150)
dosis(obj,~painkiller) <- package(value,default=100,min=400,max=100)
process(obj,id=17)
#+END_SRC


** Output

The output consists of:

-  ${B}_1, \ldots, B_{{K}}$: Starting dates for each prescription
   period.
-  ${E}_1, \ldots, E_{{K}}$: End dates for each prescription period.
-  ${X}_1, \ldots, {X}_{{K}}$: Calculated dose for each prescription
   period.

bibliographystyle:chicago
bibliography:heaven.bib



* HEADER :noexport:

#+TITLE: From \texttt{\%x\_recepter} to \texttt{Rcpp}: a new user interface and an efficient algorithm
#+AUTHOR: Helene Charlotte Rytgaard and Thomas Alexander Gerds 
#+LANGUAGE:  en
#+OPTIONS:   H:3 num:t toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:t todo:t pri:nil tags:not-in-toc author:t
#+LaTeX_CLASS: org-article
#+LaTeX_HEADER:\usepackage{authblk}
# #+LaTeX_HEADER:\author{Helene Charlotte Rytgaard and Thomas Alexander Gerds}
#+LaTeX_HEADER:\newcommand{\EE}{\mathbb{E}}
#+LaTeX_HEADER:\newcommand{\one}{1}
#+LaTeX_HEADER:\newcommand{\VV}{\mathbb{V}}
#+LaTeX_HEADER:\newcommand{\PP}{\mbox{P}}
#+LaTeX_HEADER:\newcommand{\norm}{\mathcal{N}}
#+LaTeX_HEADER:\newcommand{\lag}{N}
#+LaTeX_HEADER:\newcommand{\str}{S}
#+LaTeX_HEADER:\newcommand{\smin}{s^{\min}}
#+LaTeX_HEADER:\newcommand{\smax}{s^{\max}}
#+LaTeX_HEADER:\newcommand{\styp}{s^{*}}
#+LaTeX_HEADER:\newcommand{\period}{[a,b]}
#+LaTeX_HEADER:\newcommand{\periodK}{\ensuremath{[T_k,T_{k+1})}}
#+LaTeX_HEADER:\newcommand{\K}{K}
#+LaTeX_HEADER:\newcommand{\kk}{k}
#+LaTeX_HEADER:\newcommand{\D}{D}
#+LaTeX_HEADER:\newcommand{\B}{B}
#+LaTeX_HEADER:\newcommand{\E}{E}
#+LaTeX_HEADER:\newcommand{\XX}{X}
#+LaTeX_HEADER:\newcommand{\LL}{L}
#+LaTeX_HEADER:\newcommand{\QQ}{Q}
#+LaTeX_HEADER:\newcommand{\Ru}{R}
#+LaTeX_HEADER:\newcommand{\GG}{G}
#+LaTeX_HEADER:\newcommand{\T}{T}
#+LaTeX_HEADER:\newcommand{\st}{s}
#+LaTeX_HEADER:\newcommand{\Nn}{N}
#+LaTeX_HEADER:\newcommand{\A}{A}
#+LaTeX_HEADER:\newcommand{\C}{C}
#+LaTeX_HEADER:\newcommand{\uu}{u}
#+LaTeX_HEADER:\newcommand{\vv}{v}
#+LaTeX_HEADER:\newcommand{\zz}{z}
#+LaTeX_HEADER:\newcommand{\ww}{w}
#+LaTeX_HEADER:\newcommand{\M}{M}
#+LaTeX_HEADER:\newcommand{\I}{I}
#+LaTeX_HEADER:\newcommand{\RR}{R}
# #+LaTeX_HEADER:\affil{Department of Biostatistics, University of Copenhagen, Copenhagen, Denmark}
#+PROPERTY: header-args session *R*
#+PROPERTY: header-args cache yes
