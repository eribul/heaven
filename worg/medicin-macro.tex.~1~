% Created 2016-10-17 ma 15:56
\documentclass{article}
               \usepackage{listings}
\usepackage{color}
\usepackage{amsmath}
\usepackage{array}
\usepackage[T1]{fontenc}
\usepackage{natbib}
               \usepackage{authblk}
\newcommand{\EE}{\mathbb{E}}
\newcommand{\one}{1}
\newcommand{\VV}{\mathbb{V}}
\newcommand{\PP}{\mbox{P}}
\newcommand{\norm}{\mathcal{N}}
\newcommand{\lag}{N}
\newcommand{\str}{S}
\newcommand{\smin}{s^{\min}}
\newcommand{\smax}{s^{\max}}
\newcommand{\styp}{s^{*}}
\newcommand{\period}{[a,b]}
\newcommand{\periodK}{\ensuremath{[T_k,T_{k+1})}}
\newcommand{\K}{K}
\newcommand{\kk}{k}
\newcommand{\D}{D}
\newcommand{\B}{B}
\newcommand{\E}{E}
\newcommand{\XX}{X}
\newcommand{\LL}{L}
\newcommand{\QQ}{Q}
\newcommand{\Ru}{R}
\newcommand{\GG}{G}
\newcommand{\T}{T}
\newcommand{\st}{s}
\newcommand{\Nn}{N}
\newcommand{\A}{A}
\newcommand{\C}{C}
\newcommand{\uu}{u}
\newcommand{\vv}{v}
\newcommand{\zz}{z}
\newcommand{\ww}{w}
\newcommand{\M}{M}
\newcommand{\I}{I}
\newcommand{\RR}{R}

\lstset{
keywordstyle=\color{blue},
commentstyle=\color{red},stringstyle=\color[rgb]{0,.5,0},
basicstyle=\ttfamily\small,
columns=fullflexible,
breaklines=true,
breakatwhitespace=false,
numbers=left,
numberstyle=\ttfamily\tiny\color{gray},
stepnumber=1,
numbersep=10pt,
backgroundcolor=\color{white},
tabsize=4,
keepspaces=true,
showspaces=false,
showstringspaces=false,
xleftmargin=.23in,
frame=single,
basewidth={0.5em,0.4em},
}
\renewcommand*\familydefault{\sfdefault}
\itemsep2pt
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fixltx2e}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\author{Helene Charlotte Rytgaard and Thomas Alexander Gerds}
\date{\today}
\title{From \texttt{\%x\_recepter} to \texttt{Rcpp}: a new user interface and an efficient algorithm}
\hypersetup{
 pdfauthor={Helene Charlotte Rytgaard and Thomas Alexander Gerds},
 pdftitle={From \texttt{\%x\_recepter} to \texttt{Rcpp}: a new user interface and an efficient algorithm},
 pdfkeywords={},
 pdfsubject={},
 pdfcreator={Emacs 25.1.1 (Org mode 8.3.6)}, 
 pdflang={English}}
\begin{document}

\maketitle
\section{Introduction}
\label{sec:orgheadline1}

The Danish National Prescription Registry (NCBI) provides
individual-level data on all prescription drugs sold in Danish
community pharmacies since 1994 \citep{kildemoes2011danish}. Effects and
side effects of drugs can be assessed in a Danish nation wide registry
studies. For this the prescription data are linked to the cause of
death register and other Danish registries
\citep{thygesen2011introduction}.

This document describes a complex algorithm for the computation of
drug exposure strength and length relative to a prespecified study
period \period. Note that the start of the study period has to be
after the start of the registry.

\section{Drug prescription data}
\label{sec:orgheadline2}

We describe the data of a single person who has purchased the drug of
interest at \({K}\) different dates in the study period \period. The
setup can easily be generalized to multiple individuals. The set of
ordered drug purchase dates for one individual is denoted as
\begin{equation*}
{T}_1< \cdots< {T}_{K}.
\end{equation*}
One package of each drug product is defined by the drug strength
\(\str\) of the smallest unit (e.g., one pill or half a pill) and the
amount of such units that it contains. For each drug we distinguish
\(J\ge 1\) different package types according to the different
strengths of their smallest units: \(\str_1,\dots,\str_J\). Note that
the original SAS macro allowed at most 4 different package types. We
combine all packages purchased on the same date that share the
strength of their smallest unit. The number of smallest units of type
\(j\) purchased on date \(T_k\) is denoted by \(n_{jk}\). Thus, the
total amount \(D_k\) of the drug purchased on date \(T_k\) is given by
the formula
\begin{align*}
D_k=\sum_{j=1}^J n_{jk}\str_{j}.
\end{align*}

Figure \ref{fig:1} illustrates the data

\begin{figure}[htb]
\centering
\includegraphics[width=0.7\textwidth]{./drug-data.png}
\caption{\label{fig:1}
label til figure}
\end{figure}

\section{Hospital admission data}
\label{sec:orgheadline3}

Hospitals usually deliver drugs for their patients. It is therefore
hensigtsmaessig to take into account periods of hospitalization in the
calculation of exposure lengths. For a single individual we define up
to \(Q\) periods of hospitalization by the admission dates
\({L}_1,\ldots, {L}_{{Q}}\) and the corresponding discharge dates
\({R}_1,\ldots, {R}_{{Q}}\). 

We compute the number of days hospitalized in the period \(\periodK\)
as:
\begin{align*} 
{A}_{k} &= \sum_{q=1}^{{Q}} \max \left( 0,\,\min \left({T}_{k+1},{R}_{q}\right) - \max\left({T}_{k}, {L}_{q}\right)
\right).
\intertext{Accordingly the number of non-hospitalized days in \(\periodK\) is:}
C_k &= \left({T}_{k+1} - {T}_{k}\right) - {A}_{k}.
\end{align*}

FIXME: 
\begin{itemize}
\item need to limit to the study period \period?
\item is the day \(T_{k+1}\) included in \periodK or not?\}[3cm]
\end{itemize}

\section{Exposure strength and exposure lengths}
\label{sec:orgheadline7}

The aim is to calculate the ends of the exposure periods \(E_k\) and
for each exposure period the exposure strength per day \(X_k\). The
calculations of exposure are based on the drug prescription data and
the hospitalization dates and depend further on the following
parameters. For each drug strength \(\str_j\) the values \(\smin_j,
\smax_j, \styp_j\) define the minimal, maximal and typical dose per
day, respectively. An integer \(\lag\) defines the number of
prescription dates back in time to use in the calculations of exposure
in a given period \periodK.

To express the exposure in period \(\periodK\) we first note that
based on the total drug purchase on date \(T_k\) the individual can be
exposed at most \(n_k=\sum_{j=1}^J n_{jk}\) days. 

FIXME: would it not be more logical to use \(\tilde n_k = n_{jk}
\frac{S_j}{\smin_j}\) instead of \(n_k\)?


We use the following notation to indicate if the maximal number of
exposure days exceeds the non-hospitalized days in period \periodK:
\begin{align*} 
u_{k} = \begin{cases}
0, & n_{jk} \le C_k\\
1, & n_{jk} > C_k
\end{cases}.
\end{align*}
We use \(\bar{Y}_{k}\) to denote the history of a variable \(Y\) up to
period \(k\). For example,
\begin{align*}
\bar{D}_{k} = \left( D_{k} ,D_{k-1}, \ldots, D_1\right)
\end{align*}
is the history of total drug purchase until and including date \(T_k\).

\subsubsection{Calculating the doses, \({X}_1, \ldots, {X}_{{K}}\)}
\label{sec:orgheadline4}

HELENE: we need to adapt the following formula to the new notations.

\begin{align*} 
&{X}_{k} = (1-u_k)\, (1-u_{k-1}) \, d_{k}^*
\\ & \qquad + \, u_{k-1}\, \Big(1\{D_{k-1}=D_{k}\} \, {z}(
\bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} ) + (1\{D_{k-1}\ne D_{k}\})\,
{w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} ) \Big) \\ & \qquad +
\,u_{k} \,(1-u((D_{k-1}))\, {w}( \bar{S}_{k}, \bar{D}_{k},
\bar{{C}}_{k} ).
\end{align*}

Here, \({z}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )\) and
\({w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )\) are
calculated from the mean dose 
\begin{align*}
M^{{z}, {w}}_k = \frac{\sum_{i \in {I}^{z, w}_{k}}D_i}{\sum_{i \in {I}^{{z}, {w}}_{k}} {C}_i},
\end{align*}
where

\begin{align*}
{I}^{{w}}_{k} = \big\lbrace \min \lbrace i : u(D_i) = \cdots = u_{k-1} =1 \rbrace, \ldots, k-1\big\rbrace,
\end{align*}
and, 
\begin{align*}
{I}^{{z}}_{k} = \big\lbrace \max ( &\min \lbrace i : u(D_i) = \cdots = u_{k-1} =1 \rbrace, \\
&  \min \lbrace i : S_i = \cdots = S_{k}  \rbrace, \ldots, k-1\big\rbrace), \ldots, k-1 \big\rbrace,
\end{align*}
according to
 \begin{align*}
{z}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )& = \max\Big( d_{k}^0, \, \min \left( d_{k}^1, \, 
\text{round} ( M_{k}^{{z}} \mathbin{/} d_{k}^0) \cdot d_{k}^0\right) \Big), \\
{w}( \bar{S}_{k}, \bar{D}_{k}, \bar{{C}}_{k} )& = \one \lbrace M_{k}^{{w}} > d_{k}^1 \rbrace\, d_{k}^1 + \one\lbrace M_{k}^{{w}} < d_{k}^0 \rbrace\,  d_{k}^0 + \one \lbrace d_{k}^0 \le M_{k}^{{w}} \le d_{k}^1 \rbrace \, d_{k}^*.
\end{align*}

\subsubsection{Calculating the end dates, \({E}_1,\ldots, {E}_{k}\)}
\label{sec:orgheadline5}

\begin{align*}
{E}_{k}= \min \bigg[ {T}_{k+1}-1, \, (1-u_{k})\, (1-u_{k-1})  \, \bigg( {T}_{k} - 1+ \text{round} \left( \tfrac{D_{k} + {R}_{k}}{d_{k}^*} \right)\bigg) + \\
 \left(1-(1-u_{k})\, (1-u_{k-1}) \right)  \, \bigg( {T}_{k} - 1+ \text{round} \left( \tfrac{D_{k} + {R}_{k}}{{X}_{k}} \right)\bigg)\bigg]
\end{align*}

\subsubsection{Calculating the leftover dose, \({R}_1,\ldots, {R}_{k}\)}
\label{sec:orgheadline6}

\begin{align*}
{R}_{k} = \Big( D_{k-1} + {R}_{k-1} - {X}_{k-1} \left( {E}_{k-1} - {T}_{k-1} \right) \Big) \, u_{k}.\end{align*}



\section{User interface}
\label{sec:orgheadline9}

\subsection{Output}
\label{sec:orgheadline8}

The output consists of:

\begin{itemize}
\item \({B}_1, \ldots, B_{{K}}\): Starting dates for each prescription
period.
\item \({E}_1, \ldots, E_{{K}}\): End dates for each prescription period.
\item \({X}_1, \ldots, {X}_{{K}}\): Calculated dose for each prescription
period.
\end{itemize}

\bibliographystyle{chicago}
\bibliography{heaven}
\end{document}